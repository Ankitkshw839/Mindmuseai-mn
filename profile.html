<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MindMuseAI - Your profile page">
    <meta name="keywords" content="mental health, chatbot, therapy, mindfulness, profile, settings">
    <meta name="theme-color" content="#004080">
    <title>Profile - MindMuseAI</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script type="module" src="./firebase-config.js"></script>
    <script type="module" src="./auth.js"></script>
    <script type="module" src="./profile-manager.js"></script>
    <!-- Import Firebase storage -->
    <script type="module">
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        window.getStorage = getStorage;
        window.storageRef = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
    </script>
    <!-- Import local storage manager -->
    <script type="module" src="./local-storage.js"></script>
    <style>
        :root {
            --primary-color: #004080;  /* Dark blue */
            --accent-color: #008040;   /* Green */
            --gradient-start: #000000; /* Black */
            --gradient-end: #004080;   /* Dark blue */
        }
        
        body {
            background: linear-gradient(135deg, #000000 0%, #004080 100%);
            color: white;
        }
        
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .nav-btn {
            background-color: rgba(0, 64, 128, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background-color: rgba(0, 64, 128, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.active {
            background-color: rgba(0, 128, 64, 0.3);
            border-color: rgba(0, 128, 64, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 992px) {
            .header-actions {
                gap: 0.5rem;
            }
            
            .nav-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 768px) {
            .nav-btn span {
                display: none;
            }
            
            .nav-btn {
                padding: 0.5rem;
                aspect-ratio: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .nav-btn i {
                font-size: 1rem;
                margin: 0;
            }
            
            .header-actions {
                gap: 0.4rem;
            }
        }

        .sidebar-menu {
            width: 260px;
            background-color: rgba(10, 10, 10, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 0;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .menu-item {
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            margin-bottom: 0.2rem;
        }

        .menu-item:hover {
            background-color: rgba(0, 128, 64, 0.1);
            color: white;
        }

        .menu-item.active {
            color: white;
            border-left-color: #004080;
            background-color: rgba(0, 64, 128, 0.2);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .menu-item .menu-text {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .menu-divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.1);
            margin: 1rem 1.5rem;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            background-color: rgba(10, 10, 10, 0.6);
            min-height: 100vh;
            backdrop-filter: blur(10px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: white;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .page-header h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #004080, #008040);
            border-radius: 3px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .back-link:hover {
            color: white;
            transform: translateX(-3px);
        }

        /* Profile Layout */
        .profile-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 992px) {
            .profile-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Profile Card */
        .profile-card {
            background-color: rgba(18, 18, 18, 0.7);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            height: fit-content;
        }

        .profile-header {
            padding: 0;
            position: relative;
        }

        .profile-cover {
            height: 100px;
            background: linear-gradient(120deg, #000000, #004080, #008040);
            position: relative;
        }

        .profile-avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(-40px);
            margin-bottom: -20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #121212;
            border: 4px solid rgba(18, 18, 18, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #004080;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .edit-avatar {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: #004080;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid rgba(18, 18, 18, 0.7);
        }

        .edit-avatar:hover {
            background-color: #008040;
            transform: scale(1.1);
        }

        .profile-info {
            padding: 0 1.5rem 1.5rem;
            text-align: center;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0.5rem 0;
            color: white;
        }

        .profile-email {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 1.2rem;
        }

        .profile-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.2rem;
        }

        .meta-item {
            text-align: center;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.2rem;
        }

        .meta-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Profile Sections */
        .profile-details-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-section {
            background-color: rgba(18, 18, 18, 0.7);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .edit-btn {
            background-color: rgba(0, 64, 128, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .edit-btn:hover {
            background-color: rgba(0, 64, 128, 0.4);
            transform: translateY(-2px);
        }

        .profile-section-content {
            padding: 1.5rem;
        }

        /* Form Styles */
        .profile-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #004080;
            box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.2);
        }

        .form-group-full {
            grid-column: span 2;
        }

        .form-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1.2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn {
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #004080, #008040);
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Therapist Section */
        .therapist-card {
            display: flex;
            gap: 1.2rem;
            padding: 1.5rem;
        }

        .therapist-avatar {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #004080;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .therapist-info {
            flex: 1;
        }

        .therapist-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 0.3rem 0;
            color: white;
        }

        .therapist-title {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
        }

        .therapist-bio {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-bottom: 1.2rem;
            line-height: 1.5;
        }

        .therapist-actions {
            display: flex;
            gap: 0.8rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .content-area {
                padding: 1.5rem;
            }
            
            .profile-form {
                grid-template-columns: 1fr;
            }
            
            .form-group-full, 
            .form-actions {
                grid-column: 1;
            }
            
            .therapist-card {
                flex-direction: column;
            align-items: center;
                text-align: center;
            }
            
            .therapist-actions {
                justify-content: center;
            }
        }

        /* File upload input - hidden but accessible */
        #profile-photo-input {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        /* Upload progress overlay */
        .upload-progress-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .upload-progress-overlay.active {
            opacity: 1;
        }
        
        .progress-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .progress-text {
            color: white;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(18, 18, 18, 0.9);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }
        
        .notification.success {
            border-left: 4px solid #008040;
        }
        
        .notification.error {
            border-left: 4px solid #d32f2f;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification i {
            font-size: 1.2rem;
        }
        
        .notification.success i {
            color: #008040;
        }
        
        .notification.error i {
            color: #d32f2f;
        }
        
        .notification-message {
            flex: 1;
            color: white;
            font-size: 0.9rem;
        }
        
        .notification-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        
        .notification-close:hover {
            color: white;
        }
        
        /* Additional profile avatar styles */
        .profile-avatar img {
                width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Make sure the loading screen doesn't stay visible forever */
        .loading-screen {
            z-index: 9999;
            transition: opacity 0.5s ease-in-out;
        }
        
        .loading-screen.fade-out {
                opacity: 0;
            pointer-events: none;
        }
        
        /* Make sure the content is visible */
        .app-container, .dashboard-layout, .content-area {
            opacity: 1;
            visibility: visible;
            display: flex;
        }
        
        /* Force visibility after animation ends */
        .loading-screen.hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Loading screen immediate fix -->
    <script>
        // Immediately try to fix loading screen issues
        console.log("Immediate loading screen fix running...");
        
        // Add class to body to indicate we're loading content
        document.body.classList.add('content-loading');
        
        // Function to force-reveal the profile page
        function forceRevealContent() {
            console.log("Force revealing content...");
            
            // Hide loading screen
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = "0";
                loadingScreen.style.display = "none";
                loadingScreen.classList.add("hidden");
            }
            
            // Show content
            const appContainer = document.querySelector('.app-container');
            const dashboardLayout = document.querySelector('.dashboard-layout');
            const contentArea = document.querySelector('.content-area');
            
            if (appContainer) appContainer.style.display = "block"; 
            if (dashboardLayout) dashboardLayout.style.display = "flex";
            if (contentArea) contentArea.style.display = "block";
            
            document.body.classList.add('content-loaded');
            console.log("Content should now be visible");
        }
        
        // Try to reveal content immediately
        setTimeout(forceRevealContent, 500);
        
        // Also try again after 2 seconds
        setTimeout(forceRevealContent, 2000);
    </script>

    <!-- Loading screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <h2>MindMuseAI</h2>
            <p>Your mental wellness companion</p>
        </div>
    </div>

    <div class="app-container">
        <div class="dashboard-layout">
            <aside class="sidebar-menu">
                <a href="app.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span class="menu-text">Home</span>
                </a>
                <a href="profile.html" class="menu-item active">
                    <i class="fas fa-user-circle"></i>
                    <span class="menu-text">Profile</span>
                </a>
                <a href="progress.html" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span class="menu-text">Progress</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Settings</span>
                </a>
                <div class="menu-divider"></div>
                <a href="appointments.html" class="menu-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="menu-text">Appointments</span>
                </a>
                <a href="resources.html" class="menu-item">
                    <i class="fas fa-book"></i>
                    <span class="menu-text">Resources</span>
                </a>
                <a href="support.html" class="menu-item">
                    <i class="fas fa-headset"></i>
                    <span class="menu-text">Support</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-question-circle"></i>
                    <span class="menu-text">Help Center</span>
                </a>
            </aside>

            <main class="content-area">
                <a href="app.html" class="back-link">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Home</span>
                </a>
                
                <div class="page-header">
                    <h1>My Profile</h1>
                </div>

                <div class="profile-container">
                    <!-- Profile Sidebar Card -->
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-cover"></div>
                            <div class="profile-avatar-container">
                            <div class="profile-avatar">
                                    <!-- Default icon shown when no profile pic uploaded -->
                                    <i class="fas fa-user" id="default-avatar"></i>
                                    <!-- Profile image will be loaded here -->
                                    <img id="profile-image" src="" alt="Profile Image" style="display: none;">
                                    
                                    <!-- Progress overlay for upload -->
                                    <div class="upload-progress-overlay" id="upload-progress">
                                        <div class="progress-spinner"></div>
                                        <div class="progress-text">Uploading...</div>
                                    </div>
                                    
                                    <!-- Edit avatar button acts as label for file input -->
                                    <label for="profile-photo-input" class="edit-avatar">
                                    <i class="fas fa-camera"></i>
                                    </label>
                                    
                                    <!-- Hidden file input -->
                                    <input type="file" id="profile-photo-input" name="profile-photo-input" accept="image/*">
                            </div>
                            </div>
                            <div class="profile-info">
                            <h2 class="profile-name" id="display-name">Your Name</h2>
                            <p class="profile-email" id="profile-email">user@example.com</p>
                                
                            <div class="profile-meta">
                                <div class="meta-item">
                                    <div class="meta-value">7</div>
                                        <div class="meta-label">Sessions</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-value">14</div>
                                    <div class="meta-label">Days Active</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-value">5</div>
                                        <div class="meta-label">Check-ins</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Details Container -->
                    <div class="profile-details-container">
                        <!-- Personal Information Section -->
                        <div class="profile-section">
                            <div class="section-header">
                                <h3 class="section-title">Personal Information</h3>
                                <button class="edit-btn">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span>Edit</span>
                                </button>
                            </div>
                            <div class="profile-section-content">
                            <div class="profile-form">
                                <div class="form-group">
                                    <label for="first-name">First Name</label>
                                    <input type="text" id="first-name" value="Your">
                                </div>
                                <div class="form-group">
                                    <label for="last-name">Last Name</label>
                                    <input type="text" id="last-name" value="Name">
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" value="user@example.com">
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                        <input type="tel" id="phone" placeholder="Your phone number" pattern="[0-9]{10}" maxlength="10" minlength="10" title="Please enter exactly 10 digits" onkeypress="return /[0-9]/i.test(event.key)">
                                </div>
                                <div class="form-group">
                                    <label for="birthdate">Date of Birth</label>
                                    <input type="date" id="birthdate">
                                </div>
                                <div class="form-group">
                                    <label for="gender">Gender</label>
                                    <select id="gender">
                                        <option value="">Select gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="nonbinary">Non-binary</option>
                                        <option value="other">Other</option>
                                        <option value="prefer-not">Prefer not to say</option>
                                    </select>
                                </div>
                                <div class="form-group-full">
                                    <label for="bio">About Me</label>
                                    <textarea id="bio" rows="4" placeholder="Tell us about yourself..."></textarea>
                                </div>
                                <div class="form-actions">
                                        <button class="btn btn-secondary">Cancel</button>
                                        <button class="btn btn-primary">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Therapist Section -->
                        <div class="profile-section">
                            <div class="section-header">
                                <h3 class="section-title">Your Therapist</h3>
                            </div>
                            <div class="therapist-card">
                                <div class="therapist-avatar">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <div class="therapist-info">
                                    <h4 class="therapist-name">Dr. Sarah Johnson</h4>
                                    <p class="therapist-title">Licensed Clinical Psychologist</p>
                                    <p class="therapist-bio">Specializing in anxiety, depression, and mindfulness techniques. Dr. Johnson has been with MindMuseAI for 3 years.</p>
                                    <div class="therapist-actions">
                                        <button class="btn btn-primary">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>Schedule Session</span>
                                        </button>
                                        <button class="btn btn-secondary">
                                            <i class="fas fa-envelope"></i>
                                            <span>Message</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification element -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notification-icon"></i>
        <div class="notification-message" id="notification-message"></div>
        <button class="notification-close" id="notification-close">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        // Debug flag - turn this on to see detailed logs
        const DEBUG = true;
        
        function debugLog(...args) {
            if (DEBUG) {
                console.log('%c[Profile Debug]', 'background: #004080; color: white; padding: 2px 4px; border-radius: 3px;', ...args);
            }
        }
        
        function debugError(...args) {
            if (DEBUG) {
                console.error('%c[Profile Error]', 'background: #aa324a; color: white; padding: 2px 4px; border-radius: 3px;', ...args);
            }
        }
    </script>

    <script type="module">
        // Immediately log that the script is running
        console.log('Profile page script starting...');
        
        import { auth } from './firebase-config.js';
        import { getFirebaseApp } from './firebase-config.js';
        import StorageManager from './local-storage.js';
        
        // Log when modules are imported
        console.log('Modules imported:', { auth: !!auth, getFirebaseApp: !!getFirebaseApp, StorageManager: !!StorageManager });

        // Make StorageManager available globally for debugging
        window.StorageManager = StorageManager;
        
        // Function to handle errors and show them as notifications
        function handleError(error, message) {
            debugError(message, error);
            showNotification(message || 'An error occurred', 'error');
            console.error(error);
        }
        
        // Fix profile data saving and photo upload
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM Content Loaded');
            
            try {
                // Force reveal content if it's not yet visible
            const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                    }, 500);
                }

                // Override the authentication check if it's causing issues
                const bypassAuth = true; // Set to true to bypass Firebase auth check if causing problems
                
                // Verify StorageManager is loaded
                if (!StorageManager) {
                    handleError(new Error('StorageManager not loaded'), 'Storage manager failed to load');
                    return;
                }
                
                // Test localStorage access to ensure it's available
                if (!StorageManager.isAvailable()) {
                    handleError(new Error('Local storage not available'), 'Local storage is not available');
                    return;
                }
                
                debugLog('StorageManager available, localStorage accessible');
                
            const profileDropdown = document.querySelector('.profile-dropdown');
            const profileBtn = document.querySelector('.profile-btn');
            const userEmailEl = document.querySelector('.dropdown-user-email');
            const profileEmailEl = document.getElementById('profile-email');
            const displayNameEl = document.getElementById('display-name');
            const firstNameInput = document.getElementById('first-name');
            const lastNameInput = document.getElementById('last-name');
            const emailInput = document.getElementById('email');
                
                // Profile photo elements
                const profilePhotoInput = document.getElementById('profile-photo-input');
                const profileImage = document.getElementById('profile-image');
                const defaultAvatar = document.getElementById('default-avatar');
                const uploadProgress = document.getElementById('upload-progress');
                
                // Notification elements
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationClose = document.getElementById('notification-close');
                
                // Check if required elements exist
                debugLog('DOM Elements loaded:', {
                    profilePhotoInput: !!profilePhotoInput,
                    profileImage: !!profileImage,
                    defaultAvatar: !!defaultAvatar,
                    firstNameInput: !!firstNameInput,
                    lastNameInput: !!lastNameInput,
                    uploadProgress: !!uploadProgress,
                    notification: !!notification
                });
                
                // Function to show notification
                function showNotification(message, type = 'success') {
                    debugLog('Showing notification:', message, type);
                    
                    if (!notification || !notificationMessage || !notificationIcon) {
                        // Fallback to alert if notification elements don't exist
                        alert(`${type.toUpperCase()}: ${message}`);
                        return;
                    }
                    
                    // Set message and icon
                    notificationMessage.textContent = message;
                    
                    // Set notification type
                    notification.className = 'notification';
                    notification.classList.add(type);
                    
                    // Set icon based on type
                    if (type === 'success') {
                        notificationIcon.className = 'fas fa-check-circle';
                    } else if (type === 'error') {
                        notificationIcon.className = 'fas fa-exclamation-circle';
                    }
                    
                    // Show notification
                    notification.classList.add('show');
                    
                    // Hide after 4 seconds
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 4000);
                }
                
                // Close notification when close button is clicked
                if (notificationClose) {
                    notificationClose.addEventListener('click', function() {
                        notification.classList.remove('show');
                    });
                }
                
                // Function to convert file to base64 for local storage
                function fileToBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                    });
                }
                
                // Handle profile photo upload
                if (profilePhotoInput) {
                    debugLog('Adding event listener to profile photo input');
                    
                    profilePhotoInput.addEventListener('change', async function(e) {
                        debugLog('Profile photo input changed');
                        
                        const file = e.target.files[0];
                        if (!file) {
                            debugLog('No file selected');
                            return;
                        }
                        
                        debugLog('File selected:', file.name, file.type, file.size);
                        
                        // Check file type
                        if (!file.type.match('image.*')) {
                            showNotification('Please select an image file', 'error');
                            return;
                        }
                        
                        // Check file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification('Image size should be less than 5MB', 'error');
                            return;
                        }
                        
                        try {
                            // Show upload progress
                            if (uploadProgress) {
                                uploadProgress.classList.add('active');
                            }
                            
                            debugLog('Converting file to base64');
                            // First save to local storage as a backup
                            const base64Data = await fileToBase64(file);
                            const savedToLocal = StorageManager.media.saveProfilePhoto(base64Data);
                            debugLog('Saved to local storage:', savedToLocal);
                            
                            // Try to get Firebase app and storage
                            let uploadedToFirebase = false;
                            let downloadURL = null;
                            
                            try {
                                debugLog('Getting Firebase app');
                                const app = getFirebaseApp();
                                if (!app) throw new Error('Firebase app not available');
                                
                                debugLog('Getting Firebase storage');
                                const storage = window.getStorage(app);
                                if (!storage) throw new Error('Firebase storage not available');
                                
                                debugLog('Checking current user');
                                const user = auth.currentUser;
                                
                                if (user) {
                                    debugLog('User is logged in, uploading to Firebase');
                                    
                                    // Create storage reference
                                    const storageRef = window.storageRef(storage, `profile_photos/${user.uid}`);
                                    debugLog('Storage reference created');
                                    
                                    // Upload file
                                    debugLog('Uploading file to Firebase');
                                    const snapshot = await window.uploadBytes(storageRef, file);
                                    debugLog('File uploaded, getting download URL');
                                    
                                    // Get download URL
                                    downloadURL = await window.getDownloadURL(snapshot.ref);
                                    debugLog('Download URL received:', downloadURL);
                                    
                                    // Update user profile with photo URL
                                    debugLog('Updating user profile');
                                    await user.updateProfile({ photoURL: downloadURL });
                                    
                                    // Store the URL in local storage profile as well
                                    debugLog('Updating local profile');
                                    StorageManager.profile.updateProfileFields({ photoURL: downloadURL });
                                    
                                    uploadedToFirebase = true;
                                    debugLog('Firebase upload complete');
                                }
                            } catch (firebaseError) {
                                debugError('Firebase upload error:', firebaseError);
                                // Continue with local storage only - don't throw
                            }
                            
                            // Use the Firebase URL if available, otherwise use base64
                            const photoToDisplay = downloadURL || base64Data;
                            
                            // Display profile image
                            debugLog('Displaying profile photo');
                            displayProfilePhoto(photoToDisplay);
                            
                            // Show appropriate success message
                            if (uploadedToFirebase) {
                                showNotification('Profile photo updated successfully');
                            } else {
                                showNotification('Saved photo locally (offline mode)', 'success');
                            }
                        } catch (error) {
                            handleError(error, 'Error processing profile photo');
                        } finally {
                            // Hide upload progress
                            if (uploadProgress) {
                                uploadProgress.classList.remove('active');
                            }
                        }
                    });
                    
                    // Force the event listener to be properly attached by adding a click handler to the edit-avatar button
                    const editAvatarButton = document.querySelector('.edit-avatar');
                    if (editAvatarButton) {
                        debugLog('Adding click handler to edit avatar button');
                        editAvatarButton.addEventListener('click', function(e) {
                            debugLog('Edit avatar button clicked');
                            // This should trigger the file input
                            // The label already handles this, but this is just a safeguard
                        });
                    }
                }
                
                // Function to display profile photo
                function displayProfilePhoto(photoURL) {
                    debugLog('Display profile photo called with URL:', photoURL ? 'URL provided' : 'No URL');
                    
                    if (!profileImage || !defaultAvatar) {
                        debugError('Profile image elements not found');
                        return;
                    }
                    
                    if (photoURL) {
                        profileImage.src = photoURL;
                        profileImage.style.display = 'block';
                        defaultAvatar.style.display = 'none';
                        debugLog('Photo displayed from provided URL');
                    } else {
                        // Try to get from local storage if not provided
                        const localPhoto = StorageManager.media.getProfilePhoto();
                        debugLog('Local photo found:', !!localPhoto);
                        
                        if (localPhoto) {
                            profileImage.src = localPhoto;
                            profileImage.style.display = 'block';
                            defaultAvatar.style.display = 'none';
                            debugLog('Photo displayed from local storage');
                        } else {
                            profileImage.style.display = 'none';
                            defaultAvatar.style.display = 'block';
                            debugLog('No photo available, showing default avatar');
                        }
                    }
                }
            
            // Ensure sidebar navigation links work properly
            const sidebarLinks = document.querySelectorAll('.sidebar-menu .menu-item');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                        // Don't prevent default - let the browser handle navigation
                    const href = this.getAttribute('href');
                    if (href) {
                            debugLog("Navigating to:", href);
                        window.location.href = href;
                    }
                });
            });

            // Set active page in navigation
            function setActivePage() {
                const currentPath = window.location.pathname;
                const navButtons = document.querySelectorAll('.nav-btn');
                
                // First remove all active classes
                navButtons.forEach(button => {
                    button.classList.remove('active');
                });
                
                // Set the profile button as active since we're on the profile page
                const profileBtn = document.querySelector('#profile-page-btn');
                if (profileBtn) {
                    profileBtn.classList.add('active');
                }
            }
            
            // Call set active page
            setActivePage();

            // Check Firebase auth state
                debugLog('Adding auth state change listener');
            auth.onAuthStateChanged(function(user) {
                    debugLog('Auth state changed:', user ? 'User logged in' : 'No user');
                    
                    // Force remove loading screen immediately
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('fade-out');
                        loadingScreen.classList.add('hidden');
                        loadingScreen.style.display = 'none';
                    }
                    
                    // Don't redirect to login page for now - display profile page anyway
                    // This can be changed back once we confirm the page displays correctly
                    const skipRedirect = true;
                    
                    if (!user && !skipRedirect) {
                        // Check if we have profile data in local storage before redirecting
                        const localProfile = StorageManager.profile.getProfile();
                        debugLog('Local profile found:', !!localProfile);
                        
                        if (!localProfile) {
                            // No local profile, redirect to login
                            debugLog('No local profile, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                        } else {
                            console.log("Using local profile data (offline mode)");
                        }
                    }
                    
                    // Get profile data - try Firebase user first, then local storage
                    const localProfile = StorageManager.profile.getProfile() || {};
                    debugLog('Retrieved local profile:', localProfile);
                    
                    // Use dummy data if no profile info is available
                    const dummyProfile = {
                        displayName: 'Demo User',
                        firstName: 'Demo',
                        lastName: 'User',
                        email: 'demo@example.com',
                        photoURL: null
                    };
                    
                    // Fill profile info from available sources (Firebase user, local storage, or dummy data)
                    if (user) {
                        debugLog('Using Firebase user data');
                        // We have a Firebase user - use that data
                if (userEmailEl) userEmailEl.textContent = user.email || 'No email provided';
                if (profileEmailEl) profileEmailEl.textContent = user.email || 'No email provided';
                if (emailInput) emailInput.value = user.email || '';
                
                // Parse displayName to get first and last name
                let firstName = 'Your';
                let lastName = 'Name';
                
                if (user.displayName) {
                    const nameParts = user.displayName.split(' ');
                    if (nameParts.length >= 1) firstName = nameParts[0];
                    if (nameParts.length >= 2) lastName = nameParts.slice(1).join(' ');
                }
                        
                        debugLog('User name:', firstName, lastName);
                        
                        // Sync user data to local storage for offline usage
                        const profileData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            firstName,
                            lastName,
                            photoURL: user.photoURL
                        };
                        
                        const saved = StorageManager.profile.saveProfile(profileData);
                        debugLog('Synced user data to local storage:', saved);
                
                // Update displayed name
                const dropdownUserName = document.querySelector('.dropdown-user-name');
                if (dropdownUserName) dropdownUserName.textContent = `${firstName} ${lastName}`;
                if (displayNameEl) displayNameEl.textContent = `${firstName} ${lastName}`;
                if (firstNameInput) firstNameInput.value = firstName;
                if (lastNameInput) lastNameInput.value = lastName;
                
                        // Load additional fields from local storage if available
                        const localStoredProfile = StorageManager.profile.getProfile() || {};
                        
                        // Load all other form fields from local storage
                        const phoneInput = document.getElementById('phone');
                        const birthdateInput = document.getElementById('birthdate');
                        const genderInput = document.getElementById('gender');
                        const bioInput = document.getElementById('bio');
                        
                        if (phoneInput) phoneInput.value = localStoredProfile.phone || '';
                        if (birthdateInput) birthdateInput.value = localStoredProfile.birthdate || '';
                        if (genderInput) genderInput.value = localStoredProfile.gender || '';
                        if (bioInput) bioInput.value = localStoredProfile.bio || '';
                        
                        // Display profile photo preferring Firebase then local
                        displayProfilePhoto(user.photoURL);
                    } else {
                        debugLog('Using local profile data or dummy profile');
                        // No Firebase user - use local storage data or dummy data if nothing available
                        const useProfile = Object.keys(localProfile).length > 0 ? localProfile : dummyProfile;
                        
                        if (userEmailEl) userEmailEl.textContent = useProfile.email || 'demo@example.com';
                        if (profileEmailEl) profileEmailEl.textContent = useProfile.email || 'demo@example.com';
                        if (emailInput) emailInput.value = useProfile.email || 'demo@example.com';
                        
                        if (displayNameEl) displayNameEl.textContent = useProfile.displayName || 'Demo User';
                        if (firstNameInput) firstNameInput.value = useProfile.firstName || 'Demo';
                        if (lastNameInput) lastNameInput.value = useProfile.lastName || 'User';
                        
                        // Load all other form fields from local storage
                        const phoneInput = document.getElementById('phone');
                        const birthdateInput = document.getElementById('birthdate');
                        const genderInput = document.getElementById('gender');
                        const bioInput = document.getElementById('bio');
                        
                        if (phoneInput) phoneInput.value = useProfile.phone || '';
                        if (birthdateInput) birthdateInput.value = useProfile.birthdate || '';
                        if (genderInput) genderInput.value = useProfile.gender || '';
                        if (bioInput) bioInput.value = useProfile.bio || '';
                        
                        // Display profile photo from local storage or default
                        displayProfilePhoto(useProfile.photoURL);
                    }
                });
                
                // Save and cancel profile changes
                const saveBtn = document.querySelector('.btn-primary');
                const cancelBtn = document.querySelector('.btn-secondary');
                
            if (saveBtn) {
                    debugLog('Adding event listener to save button');
                    
                    saveBtn.addEventListener('click', async function(e) {
                        debugLog('Save button clicked');
                        // Prevent default form submission if this is in a form
                        e.preventDefault();
                        
                        // Get the input values
                        const firstName = firstNameInput ? firstNameInput.value.trim() : '';
                        const lastName = lastNameInput ? lastNameInput.value.trim() : '';
                        
                        if (!firstName || !lastName) {
                            showNotification('Please enter both first and last name', 'error');
                            return;
                        }
                        
                    const fullName = `${firstName} ${lastName}`;
                        debugLog('Saving profile with name:', fullName);
                        
                        // IMPORTANT: Update displayed name immediately for immediate feedback
                        if (displayNameEl) {
                            displayNameEl.textContent = fullName;
                            debugLog('Display name updated in UI immediately');
                        }
                        
                        // For better user experience, show notification right away
                        showNotification('Profile updated successfully');
                        
                        // Get all form field values
                        const email = document.getElementById('email') ? document.getElementById('email').value.trim() : '';
                        const phone = document.getElementById('phone') ? document.getElementById('phone').value.trim() : '';
                        const birthdate = document.getElementById('birthdate') ? document.getElementById('birthdate').value : '';
                        const gender = document.getElementById('gender') ? document.getElementById('gender').value : '';
                        const bio = document.getElementById('bio') ? document.getElementById('bio').value.trim() : '';
                        
                        // Update local storage with all profile fields
                        const profileData = {
                            displayName: fullName,
                            firstName,
                            lastName,
                            email,
                            phone,
                            birthdate,
                            gender,
                            bio,
                            lastSaved: new Date().toISOString()
                        };
                        
                        // Create a backup in case storage fails
                        try {
                            // Save to localStorage directly as fallback
                            localStorage.setItem('mindmuse_name_backup', JSON.stringify({
                                displayName: fullName,
                                firstName,
                                lastName
                            }));
                        } catch (e) {
                            console.error('Failed to save name backup:', e);
                        }
                        
                        // Try StorageManager save
                        const savedLocally = StorageManager.profile.updateProfileFields(profileData);
                        debugLog('Saved to local storage:', savedLocally);
                        
                        if (!savedLocally) {
                            showNotification('Warning: Profile saved to display only', 'error');
                        }
                    
                    // Save to Firebase Realtime Database
                    if (window.profileManager) {
                        try {
                            debugLog('Saving to Firebase Realtime Database');
                            await window.profileManager.saveProfile(profileData);
                            debugLog('Profile saved to Firebase Realtime Database successfully');
                        } catch (error) {
                            debugError('Error saving to Firebase Realtime Database:', error);
                            showNotification('Profile saved locally, but cloud sync failed', 'error');
                        }
                    }

                    const currentUser = auth.currentUser;
                    if (currentUser) {
                            debugLog('Updating Firebase profile');
                        // Update display name in Firebase
                        currentUser.updateProfile({
                            displayName: fullName
                        }).then(() => {
                                debugLog("Profile updated successfully in Firebase");
                                // Show success notification again after Firebase success
                                showNotification('Profile saved to cloud successfully');
                        }).catch((error) => {
                                debugError("Error updating profile in Firebase:", error);
                                showNotification('Profile saved locally only', 'success');
                            });
                        } else {
                            debugLog('No Firebase user, using local storage only');
                        }
                    });
                } else {
                    console.error('Save button not found in the DOM!');
                }
                
                // Handle cancel button click
                if (cancelBtn) {
                    debugLog('Adding event listener to cancel button');
                    
                    cancelBtn.addEventListener('click', function(e) {
                        debugLog('Cancel button clicked');
                        e.preventDefault();
                        
                        // Get the profile data from local storage
                        const storedProfile = StorageManager.profile.getProfile() || {};
                        
                        // Reset form fields to stored values
                        if (firstNameInput) firstNameInput.value = storedProfile.firstName || '';
                        if (lastNameInput) lastNameInput.value = storedProfile.lastName || '';
                        if (emailInput) emailInput.value = storedProfile.email || '';
                        
                        const phoneInput = document.getElementById('phone');
                        const birthdateInput = document.getElementById('birthdate');
                        const genderInput = document.getElementById('gender');
                        const bioInput = document.getElementById('bio');
                        
                        if (phoneInput) phoneInput.value = storedProfile.phone || '';
                        if (birthdateInput) birthdateInput.value = storedProfile.birthdate || '';
                        if (genderInput) genderInput.value = storedProfile.gender || '';
                        if (bioInput) bioInput.value = storedProfile.bio || '';
                        
                        showNotification('Changes cancelled', 'success');
                    });
                }
                
                // Add direct click handler as a backup to ensure the save button works
                document.querySelectorAll('.btn-primary, .save-btn, button[type="submit"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        debugLog('Alternative save button clicked:', this);
                        
                        // If this isn't the main save button we already handled
                        if (this !== saveBtn) {
                            e.preventDefault();
                            
                            // Get values from all form fields
                            const firstName = document.getElementById('first-name')?.value.trim() || '';
                            const lastName = document.getElementById('last-name')?.value.trim() || '';
                            const email = document.getElementById('email')?.value.trim() || '';
                            const phone = document.getElementById('phone')?.value.trim() || '';
                            const birthdate = document.getElementById('birthdate')?.value || '';
                            const gender = document.getElementById('gender')?.value || '';
                            const bio = document.getElementById('bio')?.value.trim() || '';
                            
                            if (!firstName || !lastName) {
                                alert('Please enter both first and last name');
                                return;
                            }
                            
                            // Update display
                            const fullName = `${firstName} ${lastName}`;
                            const displayNameEl = document.getElementById('display-name');
                            if (displayNameEl) {
                                displayNameEl.textContent = fullName;
                            }
                            
                            // Save locally
                            try {
                                // Save all profile fields
                                if (window.StorageManager) {
                                    window.StorageManager.profile.updateProfileFields({
                                        displayName: fullName,
                                        firstName,
                                        lastName,
                                        email,
                                        phone,
                                        birthdate,
                                        gender,
                                        bio,
                                        lastSaved: new Date().toISOString()
                                    });
                                }
                                
                                // Show feedback
                                showNotification('Profile saved successfully!', 'success');
                            } catch (err) {
                                console.error('Error saving profile:', err);
                                showNotification('Error saving profile. Please try again.', 'error');
                            }
                        }
                    });
                });
                
                // Initial display of profile photo (from local storage or Firebase)
                const initialUser = auth.currentUser;
                if (initialUser && initialUser.photoURL) {
                    debugLog('Displaying initial photo from Firebase user');
                    displayProfilePhoto(initialUser.photoURL);
                } else {
                    debugLog('Checking for photo in local storage');
                    const localProfile = StorageManager.profile.getProfile() || {};
                    if (localProfile.photoURL) {
                        debugLog('Displaying photo from local profile');
                        displayProfilePhoto(localProfile.photoURL);
                    } else {
                        debugLog('Checking media storage for photo');
                        const mediaPhoto = StorageManager.media.getProfilePhoto();
                        if (mediaPhoto) {
                            debugLog('Displaying photo from media storage');
                            displayProfilePhoto(mediaPhoto);
                        } else {
                            debugLog('No photo found, showing default avatar');
                        }
                    }
                }
                
                // For debugging - log profile information
                debugLog('Current profile information:', {
                    firebaseUser: auth.currentUser ? {
                        displayName: auth.currentUser.displayName,
                        email: auth.currentUser.email,
                        photoURL: !!auth.currentUser.photoURL
                    } : 'No user',
                    localProfile: StorageManager.profile.getProfile(),
                    mediaPhoto: !!StorageManager.media.getProfilePhoto()
                });
                
                // Show initial notification to confirm the page is working
                showNotification('Profile page loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error in profile page initialization:', error);
                // Force loading screen to disappear
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.add('fade-out');
                    loadingScreen.classList.add('hidden');
                }
            }
        });
        
        // Additional failsafe - force page to display after 5 seconds
        setTimeout(function() {
            const contentArea = document.querySelector('.content-area');
            const dashboardLayout = document.querySelector('.dashboard-layout');
            const appContainer = document.querySelector('.app-container');
            
            if (contentArea) contentArea.style.display = 'block';
            if (dashboardLayout) dashboardLayout.style.display = 'flex';
            if (appContainer) appContainer.style.display = 'block';
            
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
                loadingScreen.classList.add('hidden');
            }
            
            document.body.classList.add('loaded');
            console.log('Forced page content to display (timeout)');
        }, 5000);
    </script>
</body>

</html> 